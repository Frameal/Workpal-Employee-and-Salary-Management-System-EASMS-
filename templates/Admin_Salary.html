<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Salary Management</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    body {
      background-color: #fffcf9;
    }

  .navbar {
    background-color: #fdecd2;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    border-bottom: 1px solid #f5c56d;
    box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.2);
  }

  .navbar-left {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  .navbar-left img.logo-img {
    width: 120px;
    height: auto;
    margin-bottom: 1px;
    margin-left: 20px;
    margin-top: 10px;
  }

  .navbar-menu {
    display: flex;
    gap: 30px;
    align-items: center;
  }

  .navbar-menu img {
    width: 25px;
    height: 25px;
  }

  .navbar-menu a {
    text-decoration: none;
    color: #e78f77;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px;
    border-radius: 12px;
    transition: background-color 0.3s;
  }

  .navbar-menu a:hover {
    background-color: #feded1;
  }

    .main-container {
      padding: 40px 60px;
      margin-top: 30px;
    }

    h1 {
      text-align: center;
      color: #e78f77;
      margin-bottom: 30px;
    }

    .search-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 40px;
    }

    .search-container label {
      background-color: #fdecd2;
      padding: 10px 20px;
      border-radius: 10px 0 0 10px;
      color: #e78f77;
      font-weight: bold;
    }

    .search-container input {
      padding: 10px;
      width: 300px;
      border: 1px solid #ccc;
    }

    .search-container button {
      padding: 10px 20px;
      background-color: #feded1;
      color: #e78f77;
      border: none;
      border-radius: 0 10px 10px 0;
      cursor: pointer;
    }

    .results-box {
      width: 100%;
      height: 300px;
      border: 1px solid #767272;
      border-radius: 10px;
      margin-bottom: 40px;
      box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.2);
      overflow: auto;
      background-color: white;
    }

    .salary-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1400px;
    }

    .salary-table th,
    .salary-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .salary-table th {
      background-color: #fdecd2;
      color: #e78f77;
      font-weight: bold;
      position: sticky;
      top: 0;
    }

    .salary-table td {
      color: #383838;
    }

    .salary-table tr:hover {
      background-color: #fffcf9;
      cursor: pointer;
    }

    .no-data {
      text-align: center;
      color: #999;
      padding: 20px;
      font-style: italic;
    }

    .form-row {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
      margin-top: 30px;
    }

    .form-box {
      background-color: #fdecd2;
      padding: 30px;
      border-radius: 16px;
      width: 50%;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 10px;
      box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.2);
    }

    .form-field {
      width: 30%;
      margin-bottom: 20px;
      color: #e78f77;
      font-weight: bold;
    }

    .form-field input {
      width: 100%;
      padding: 6px 10px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      height: 30px;
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 20px;
      margin-top: 10px;
    }

    .button-group button {
      background-color: #feded1;
      color: #e78f77;
      border: none;
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s;
    }

    .button-group button:hover {
      background-color: #f5c56d;
    }

  </style>
</head>
<body>
  <div class="navbar">
    <div class="navbar-left">
      <img src="images/logo_admin.png" alt="EASMS Logo" class="logo-img" />
    </div>
    <div class="navbar-menu">
      <a href="{{ url_for('admin_dashboard', admin_id=admin_id) }}"><img src="images/dashboard.png" alt="Dashboard Icon"/> Dashboard</a>
      <a href="{{ url_for('admin_attendance', admin_id=admin_id) }}"><img src="images/attendance.png" alt="Attendance Icon"/> Attendance</a>
      <a href="{{ url_for('admin_salary', admin_id=admin_id) }}"><img src="images/salary.png" alt="Salary Icon"/> Salary</a>
      <a href="{{ url_for('admin_employee_data', admin_id=admin_id) }}"><img src="images/employee.png" alt="Employee Icon"/> Employee</a>
      <a href="{{ url_for('home') }}"><img src="images/logout.png" alt="Exit Admin"/> Log out</a>
    </div>
  </div>

  <div class="main-container">
    <h1>Salary Management</h1>

    <div class="search-container">  
      <label for="search">Search Employee ID:</label>
      <input type="text" id="search" />
      <button>Search</button>
    </div>

    <div class="results-box">
      <table class="salary-table" id="salary-table">
        <thead>
          <tr>
            <th>Payroll ID</th>
            <th>Employee ID</th>
            <th>Name</th>
            <th>Basic Salary</th>
            <th>Total Hours</th>
            <th>OT Hours</th>
            <th>Basic Pay/Hr</th>
            <th>OT Pay/Hr</th>
            <th>Gross Salary</th>
            <th>Bonus</th>
            <th>PAGIBIG</th>
            <th>PhilHealth</th>
            <th>SSS</th>
            <th>Tax</th>
            <th>Total Deduction</th>
            <th>Net Salary</th>
          </tr>
        </thead>
        <tbody id="salary-tbody">
          <tr>
            <td colspan="16" class="no-data">Loading payroll records...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="form-row">
      <div class="form-box">
        <div class="form-field">
          <label>Payroll ID:</label>
          <input type="text" id="payroll_id" readonly />
        </div>
        <div class="form-field">
          <label>Employee ID:</label>
          <input type="text" id="employee_id" />
        </div>
        <div class="form-field">
          <label>Total Hours:</label>
          <input type="number" step="0.01" id="total_hours" />
        </div>
        <div class="form-field">
          <label>Total Overtime Hours:</label>
          <input type="number" step="0.01" id="total_overtime_hours" />
        </div>
        <div class="form-field">
          <label>Basic Salary:</label>
          <input type="number" step="0.01" id="basic_salary" />
        </div>
        <div class="form-field">
          <label>Basic Pay per Hour:</label>
          <input type="number" step="0.01" id="basic_pay_per_hour" />
        </div>
        <div class="form-field">
          <label>Overtime Pay per Hour:</label>
          <input type="number" step="0.01" id="overtime_pay_per_hour" />
        </div>
        <div class="form-field">
          <label>Gross Salary:</label>
          <input type="number" step="0.01" id="gross_salary" />
        </div>
        <div class="form-field">
          <label>PAGIBIG:</label>
          <input type="number" step="0.01" id="pagibig" />
        </div>
        <div class="form-field">
          <label>PhilHealth:</label>
          <input type="number" step="0.01" id="philhealth" />
        </div>
        <div class="form-field">
          <label>SSS:</label>
          <input type="number" step="0.01" id="SSS" />
        </div>
        <div class="form-field">
          <label>Tax:</label>
          <input type="number" step="0.01" id="tax" />
        </div>
        <div class="form-field">
          <label>Total Deduction:</label>
          <input type="number" step="0.01" id="total_deduction" />
        </div>
        <div class="form-field">
          <label>Bonus:</label>
          <input type="number" step="0.01" id="bonus" />
        </div>
        <div class="form-field">
          <label>Net Salary:</label>
          <input type="number" step="0.01" id="net_salary" />
        </div>
      </div>

      <div class="button-group">
        <button onclick="handleSelect()">SELECT</button>
        <button onclick="handleUpdate()">UPDATE</button>
        <button onclick="handleNew()">NEW</button>
        <button onclick="handleClear()">CLEAR</button>
        <button onclick="handleAdd()">ADD</button>
        <button onclick="handleDelete()">DELETE</button>
      </div>
    </div>
  </div>

  <script>
let currentPayrollRecords = [];
let selectedPayroll = null;
let selectedRow = null;

document.addEventListener('DOMContentLoaded', function() {
    loadAllPayrollRecords();
});

function loadAllPayrollRecords() {
    fetch(`/get_all_payroll/{{ admin_id }}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentPayrollRecords = data.data;
                displayPayrollRecords(currentPayrollRecords);
            } else {
                showError(data.message);
            }
        })
        .catch(error => {
            showError('Error loading payroll records: ' + error.message);
        });
}

function displayPayrollRecords(records) {
    const tbody = document.getElementById('salary-tbody');
    tbody.innerHTML = '';
    
    if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="16" class="no-data">No payroll records found</td></tr>';
        return;
    }
    
    records.forEach(record => {
        const row = tbody.insertRow();
        row.onclick = () => selectRecord(row);
        row.setAttribute('data-payroll-id', record.payroll_id);
        row.setAttribute('data-employee-id', record.employee_id || '');
        row.setAttribute('data-employee-name', record.employee_name || '');
        row.setAttribute('data-total-hours', record.total_hours || '');
        row.setAttribute('data-total-overtime-hours', record.total_overtime_hours || '');
        row.setAttribute('data-basic-salary', record.basic_salary || '');
        row.setAttribute('data-basic-pay-per-hour', record.basic_pay_per_hour || '');
        row.setAttribute('data-overtime-pay-per-hour', record.overtime_pay_per_hour || '');
        row.setAttribute('data-gross-salary', record.gross_salary || '');
        row.setAttribute('data-pagibig', record.pagibig || '');
        row.setAttribute('data-philhealth', record.philhealth || '');
        row.setAttribute('data-sss', record.SSS || '');
        row.setAttribute('data-tax', record.tax || '');
        row.setAttribute('data-total-deduction', record.total_deduction || '');
        row.setAttribute('data-bonus', record.bonus || '');
        row.setAttribute('data-net-salary', record.net_salary || '');

        const employeeName = record.employee_name || 'N/A';
        
        row.innerHTML = `
            <td>${record.payroll_id}</td>
            <td>${record.employee_id || 'N/A'}</td>
            <td>${employeeName}</td>
            <td>₱${parseFloat(record.basic_salary || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
            <td>${parseFloat(record.total_hours || 0).toFixed(2)}</td>
            <td>${parseFloat(record.total_overtime_hours || 0).toFixed(2)}</td>
            <td>₱${parseFloat(record.basic_pay_per_hour || 0).toFixed(2)}</td>
            <td>₱${parseFloat(record.overtime_pay_per_hour || 0).toFixed(2)}</td>
            <td>₱${parseFloat(record.gross_salary || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
            <td>₱${parseFloat(record.bonus || 0).toFixed(2)}</td>
            <td>₱${parseFloat(record.pagibig || 0).toFixed(2)}</td>
            <td>₱${parseFloat(record.philhealth || 0).toFixed(2)}</td>
            <td>₱${parseFloat(record.SSS || 0).toFixed(2)}</td>
            <td>₱${parseFloat(record.tax || 0).toFixed(2)}</td>
            <td>₱${parseFloat(record.total_deduction || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
            <td>₱${parseFloat(record.net_salary || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
        `;
    });
}

function selectRecord(row) {
    if (selectedRow && selectedRow !== row) {
        selectedRow.style.backgroundColor = '';
        selectedRow.style.color = '';
    }

    selectedRow = row;
    row.style.backgroundColor = '#e78f77';
    row.style.color = 'white';

    const payrollId = row.getAttribute('data-payroll-id');
    selectedPayroll = currentPayrollRecords.find(record => record.payroll_id == payrollId);
    
    document.getElementById('payroll_id').value = row.getAttribute('data-payroll-id') || '';
    document.getElementById('employee_id').value = row.getAttribute('data-employee-id') || '';
    document.getElementById('total_hours').value = row.getAttribute('data-total-hours') || '';
    document.getElementById('total_overtime_hours').value = row.getAttribute('data-total-overtime-hours') || '';
    document.getElementById('basic_salary').value = row.getAttribute('data-basic-salary') || '';
    document.getElementById('basic_pay_per_hour').value = row.getAttribute('data-basic-pay-per-hour') || '';
    document.getElementById('overtime_pay_per_hour').value = row.getAttribute('data-overtime-pay-per-hour') || '';
    document.getElementById('gross_salary').value = row.getAttribute('data-gross-salary') || '';
    document.getElementById('pagibig').value = row.getAttribute('data-pagibig') || '';
    document.getElementById('philhealth').value = row.getAttribute('data-philhealth') || '';
    document.getElementById('SSS').value = row.getAttribute('data-sss') || '';
    document.getElementById('tax').value = row.getAttribute('data-tax') || '';
    document.getElementById('total_deduction').value = row.getAttribute('data-total-deduction') || '';
    document.getElementById('bonus').value = row.getAttribute('data-bonus') || '';
    document.getElementById('net_salary').value = row.getAttribute('data-net-salary') || '';
}

document.querySelector('.search-container button').addEventListener('click', function() {
    const searchId = document.getElementById('search').value.trim();
    
    if (!searchId) {
        loadAllPayrollRecords();
        return;
    }
    
    fetch(`/search_payroll/{{ admin_id }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ employee_id: searchId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentPayrollRecords = data.data;
            displayPayrollRecords(currentPayrollRecords);
            if (data.data.length > 0) {
                setTimeout(() => {
                    const firstRow = document.querySelector('#salary-tbody tr');
                    if (firstRow && !firstRow.querySelector('.no-data')) {
                        selectRecord(firstRow);
                    }
                }, 100);
            }
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        showError('Search error: ' + error.message);
    });
});

document.getElementById('search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.querySelector('.search-container button').click();
    }
});

document.getElementById('search').addEventListener('input', function() {
    if (this.value.trim() === '') {
        loadAllPayrollRecords();
        handleClear();
    }
});

function handleSelect() {
    if (!selectedRow) {
        showError('Please click on a record to select it');
        return;
    }
    showSuccess('Record selected successfully');
}

function handleUpdate() {
    if (!selectedPayroll) {
        showError('Please select a payroll record first');
        return;
    }
    
    const formData = getFormData();
    
    fetch(`/manage_payroll/{{ admin_id }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'update',
            data: formData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            loadAllPayrollRecords();
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        showError('Update error: ' + error.message);
    });
}

function handleNew() {
    handleClear();
    showSuccess('Ready for new payroll entry');
}

function handleClear() {
    document.querySelectorAll('.form-field input').forEach(input => {
        input.value = '';
    });
    selectedPayroll = null;
    
    if (selectedRow) {
        selectedRow.style.backgroundColor = '';
        selectedRow.style.color = '';
        selectedRow = null;
    }
}

function handleAdd() {
    const formData = getFormData();
    
    if (!formData.employee_id) {
        showError('Please fill in required field: Employee ID');
        return;
    }
    
    fetch(`/manage_payroll/{{ admin_id }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'add',
            data: formData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            loadAllPayrollRecords();
            handleClear();
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        showError('Add error: ' + error.message);
    });
}

function handleDelete() {
    if (!selectedPayroll) {
        showError('Please select a payroll record first');
        return;
    }
    
    if (!confirm('Are you sure you want to delete this payroll record?')) {
        return;
    }
    
    fetch(`/manage_payroll/{{ admin_id }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'delete',
            data: { payroll_id: selectedPayroll.payroll_id }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            loadAllPayrollRecords();
            handleClear();
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        showError('Delete error: ' + error.message);
    });
}

function getFormData() {
    return {
        payroll_id: document.getElementById('payroll_id').value,
        employee_id: document.getElementById('employee_id').value,
        total_hours: document.getElementById('total_hours').value,
        total_overtime_hours: document.getElementById('total_overtime_hours').value,
        basic_salary: document.getElementById('basic_salary').value,
        basic_pay_per_hour: document.getElementById('basic_pay_per_hour').value,
        overtime_pay_per_hour: document.getElementById('overtime_pay_per_hour').value,
        gross_salary: document.getElementById('gross_salary').value,
        pagibig: document.getElementById('pagibig').value,
        philhealth: document.getElementById('philhealth').value,
        SSS: document.getElementById('SSS').value,
        tax: document.getElementById('tax').value,
        total_deduction: document.getElementById('total_deduction').value,
        bonus: document.getElementById('bonus').value,
        net_salary: document.getElementById('net_salary').value
    };
}

function showError(message) {
    alert('Error: ' + message);
}

function showSuccess(message) {
    alert('Success: ' + message);
}
</script>
</body>
</html>